

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Managing Jobs at OLCF &mdash; AMReX-Astro 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="_static/theme_overrides.css?v=5694489b" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=f2a433a1"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="_static/copybutton.js?v=eaa7b67c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Running Jupyter Remotely from OLCF" href="olcf-jupyter.html" />
    <link rel="prev" title="Compiling at OLCF" href="olcf-compilers.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            AMReX-Astro
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">AMReX Astro basics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="alcf.html">Working at ALCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="nersc.html">Working at NERSC</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="olcf.html">Working at OLCF</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="olcf-compilers.html">Compiling at OLCF</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Managing Jobs at OLCF</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#frontier">Frontier</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#machine-details">Machine details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#submitting-jobs">Submitting jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gpu-aware-mpi">GPU-aware MPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#job-status">Job Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#job-chaining">Job Chaining</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging">Debugging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="olcf-jupyter.html">Running Jupyter Remotely from OLCF</a></li>
<li class="toctree-l2"><a class="reference internal" href="olcf-kronos.html">Archiving Data on Kronos</a></li>
<li class="toctree-l2"><a class="reference internal" href="olcf-andes.html">Batch Visualization on Andes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="iacs.html">Working at IACS</a></li>
<li class="toctree-l1"><a class="reference internal" href="workstations.html">Linux Workstations</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">AMReX-Astro</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="olcf.html">Working at OLCF</a></li>
      <li class="breadcrumb-item active">Managing Jobs at OLCF</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/olcf-workflow.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="managing-jobs-at-olcf">
<h1>Managing Jobs at OLCF<a class="headerlink" href="#managing-jobs-at-olcf" title="Link to this heading"></a></h1>
<section id="frontier">
<h2>Frontier<a class="headerlink" href="#frontier" title="Link to this heading"></a></h2>
<section id="machine-details">
<h3>Machine details<a class="headerlink" href="#machine-details" title="Link to this heading"></a></h3>
<p>Queue policies are here:
<a class="reference external" href="https://docs.olcf.ornl.gov/systems/frontier_user_guide.html#scheduling-policy">https://docs.olcf.ornl.gov/systems/frontier_user_guide.html#scheduling-policy</a></p>
<p>Filesystem is called <code class="docutils literal notranslate"><span class="pre">orion</span></code>, and is Lustre:
<a class="reference external" href="https://docs.olcf.ornl.gov/systems/frontier_user_guide.html#data-and-storage">https://docs.olcf.ornl.gov/systems/frontier_user_guide.html#data-and-storage</a></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The Orion / Lustre filesystem has been broken since Jan 2025 making I/O performance
very unstable.  To work around this problem we currently advise having each MPI
process write its own file.  This is enabled automatically in the submission script
below.  Restarting is also an issue, with 50% of restarts hanging due to filesystem
issues.  The script below will kill the job after 5 minutes if it detects that the
restart has failed.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We also explicitly set the filesystem striping using the LFS tools to help I/O
performance.</p>
</div>
</section>
<section id="submitting-jobs">
<h3>Submitting jobs<a class="headerlink" href="#submitting-jobs" title="Link to this heading"></a></h3>
<p>Frontier uses SLURM.</p>
<p>Here’s a script that uses our best practices on Frontier.  It uses 64 nodes (512 GPUs)
and does the following:</p>
<ul>
<li><p>Sets the filesystem striping (see <a class="reference external" href="https://docs.olcf.ornl.gov/data/index.html#lfs-setstripe-wrapper">https://docs.olcf.ornl.gov/data/index.html#lfs-setstripe-wrapper</a>)</p></li>
<li><p>Includes logic for automatically restarting from the last checkpoint file
(useful for job-chaining).  This is done via the <code class="docutils literal notranslate"><span class="pre">find_chk_file</span></code> function.</p></li>
<li><p>Installs a signal handler to create a <code class="docutils literal notranslate"><span class="pre">dump_and_stop</span></code> file shortly before
the queue window ends.  This ensures that we get a checkpoint at the very
end of the queue window.</p></li>
<li><p>Can do a special check on restart to ensure that we don’t hang on
reading the initial checkpoint file (uncomment out the line):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>sleep<span class="w"> </span><span class="m">300</span><span class="p">;</span><span class="w"> </span>check_restart<span class="w"> </span><span class="o">)</span><span class="w"> </span><span class="p">&amp;</span>
</pre></div>
</div>
<p>This uses the <code class="docutils literal notranslate"><span class="pre">check_restart</span></code> function and will kill the job if it doesn’t
detect a successful restart within 5 minutes.</p>
</li>
<li><p>Adds special I/O parameters to the job to work around filesystem issues
(these are defined in <code class="docutils literal notranslate"><span class="pre">FILE_IO_PARAMS</span></code>.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH -A AST106</span>
<span class="c1">#SBATCH -J subch</span>
<span class="c1">#SBATCH -o %x-%j.out</span>
<span class="c1">#SBATCH -t 02:00:00</span>
<span class="c1">#SBATCH -p batch</span>
<span class="c1"># here N is the number of compute nodes</span>
<span class="c1">#SBATCH -N 64</span>
<span class="c1">#SBATCH --ntasks-per-node=8</span>
<span class="c1">#SBATCH --cpus-per-task=7</span>
<span class="c1">#SBATCH --gpus-per-task=1</span>
<span class="c1">#SBATCH --gpu-bind=closest</span>
<span class="c1">#SBATCH --signal=B:URG@300</span>

<span class="nv">EXEC</span><span class="o">=</span>./Castro3d.hip.x86-trento.MPI.HIP.SMPLSDC.ex
<span class="nv">INPUTS</span><span class="o">=</span>inputs_3d.N14.coarse

module<span class="w"> </span>load<span class="w"> </span>cpe
module<span class="w"> </span>load<span class="w"> </span>PrgEnv-gnu
module<span class="w"> </span>load<span class="w"> </span>cray-mpich
module<span class="w"> </span>load<span class="w"> </span>craype-accel-amd-gfx90a
module<span class="w"> </span>load<span class="w"> </span>rocm/6.3.1

<span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$CRAY_LD_LIBRARY_PATH</span>:<span class="nv">$LD_LIBRARY_PATH</span>

<span class="c1"># set the file system striping</span>

<span class="nb">echo</span><span class="w"> </span><span class="nv">$SLURM_SUBMIT_DIR</span>

module<span class="w"> </span>load<span class="w"> </span>lfs-wrapper
lfs<span class="w"> </span>setstripe<span class="w"> </span>-c<span class="w"> </span><span class="m">32</span><span class="w"> </span>-S<span class="w"> </span>10M<span class="w"> </span><span class="nv">$SLURM_SUBMIT_DIR</span>

<span class="k">function</span><span class="w"> </span>find_chk_file<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># find_chk_file takes a single argument -- the wildcard pattern</span>
<span class="w">    </span><span class="c1"># for checkpoint files to look through</span>
<span class="w">    </span><span class="nv">chk</span><span class="o">=</span><span class="nv">$1</span>

<span class="w">    </span><span class="c1"># find the latest 2 restart files.  This way if the latest didn&#39;t</span>
<span class="w">    </span><span class="c1"># complete we fall back to the previous one.</span>
<span class="w">    </span><span class="nv">temp_files</span><span class="o">=</span><span class="k">$(</span>find<span class="w"> </span>.<span class="w"> </span>-maxdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">chk</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-print<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-2<span class="k">)</span>
<span class="w">    </span><span class="nv">restartFile</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">temp_files</span><span class="si">}</span>
<span class="w">    </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># the Header is the last thing written -- check if it&#39;s there, otherwise,</span>
<span class="w">        </span><span class="c1"># fall back to the second-to-last check file written</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="si">${</span><span class="nv">f</span><span class="si">}</span>/Header<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nv">restartFile</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="nv">restartFile</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="o">}</span>

<span class="c1"># look for 7-digit chk files</span>
find_chk_file<span class="w"> </span><span class="s2">&quot;*chk???????&quot;</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">restartFile</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># look for 6-digit chk files</span>
<span class="w">    </span>find_chk_file<span class="w"> </span><span class="s2">&quot;*chk??????&quot;</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">restartFile</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># look for 5-digit chk files</span>
<span class="w">    </span>find_chk_file<span class="w"> </span><span class="s2">&quot;*chk?????&quot;</span>
<span class="k">fi</span>

<span class="c1"># restartString will be empty if no chk files are found -- i.e. new run</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">restartFile</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">restartString</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nv">restartString</span><span class="o">=</span><span class="s2">&quot;amr.restart=</span><span class="si">${</span><span class="nv">restartFile</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">fi</span>


<span class="c1"># clean up any run management files left over from previous runs</span>
rm<span class="w"> </span>-f<span class="w"> </span>dump_and_stop

<span class="c1"># The `--signal=B:URG@&lt;n&gt;` option tells slurm to send SIGURG to this batch</span>
<span class="c1"># script n seconds before the runtime limit, so we can exit gracefully.</span>
<span class="k">function</span><span class="w"> </span>sig_handler<span class="w"> </span><span class="o">{</span>
<span class="w">    </span>touch<span class="w"> </span>dump_and_stop
<span class="w">    </span><span class="c1"># disable this signal handler</span>
<span class="w">    </span><span class="nb">trap</span><span class="w"> </span>-<span class="w"> </span>URG
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;BATCH: allocation ending soon; telling Castro to dump a checkpoint and stop&quot;</span>
<span class="o">}</span>
<span class="nb">trap</span><span class="w"> </span>sig_handler<span class="w"> </span>URG


<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NMPI_PER_NODE</span><span class="o">=</span><span class="m">8</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">TOTAL_NMPI</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="si">${</span><span class="nv">SLURM_JOB_NUM_NODES</span><span class="si">}</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="si">${</span><span class="nv">NMPI_PER_NODE</span><span class="si">}</span><span class="w"> </span><span class="k">))</span>

<span class="k">function</span><span class="w"> </span>check_restart<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;RESTART CHECK!!!&quot;</span>
<span class="w">    </span><span class="nv">outfile</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SLURM_JOB_NAME</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">SLURM_JOB_ID</span><span class="si">}</span><span class="s2">.out&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;RESTART CHECK: checking </span><span class="si">${</span><span class="nv">outfile</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">restart_success</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">&quot;Restart time&quot;</span><span class="w"> </span><span class="si">${</span><span class="nv">outfile</span><span class="si">}</span><span class="k">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">       </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;RESTART CHECK: canceling job&quot;</span>
<span class="w">       </span>date
<span class="w">       </span>scancel<span class="w"> </span><span class="nv">$SLURM_JOB_ID</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">       </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;RESTART CHECK: restart appears to be successful&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>


<span class="c1"># frontier&#39;s file system is troublesome, so modify the way</span>
<span class="c1"># we have AMReX does I/O</span>

<span class="nv">FILE_IO_PARAMS</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">amr.plot_nfiles = -1</span>
<span class="s2">amr.checkpoint_nfiles = -1</span>
<span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span>appending<span class="w"> </span>parameters:<span class="w"> </span><span class="si">${</span><span class="nv">FILE_IO_PARAMS</span><span class="si">}</span>

<span class="o">(</span>sleep<span class="w"> </span><span class="m">300</span><span class="p">;</span><span class="w"> </span>check_restart<span class="w"> </span><span class="o">)</span><span class="w"> </span><span class="p">&amp;</span>

<span class="c1"># execute srun in the background then use the builtin wait so the shell can</span>
<span class="c1"># handle the signal</span>
srun<span class="w"> </span>-n<span class="si">${</span><span class="nv">TOTAL_NMPI</span><span class="si">}</span><span class="w"> </span>-N<span class="si">${</span><span class="nv">SLURM_JOB_NUM_NODES</span><span class="si">}</span><span class="w"> </span>--ntasks-per-node<span class="o">=</span><span class="m">8</span><span class="w"> </span>--gpus-per-task<span class="o">=</span><span class="m">1</span><span class="w"> </span>./<span class="nv">$EXEC</span><span class="w"> </span><span class="nv">$INPUTS</span><span class="w"> </span><span class="si">${</span><span class="nv">restartString</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">FILE_IO_PARAMS</span><span class="si">}</span><span class="w"> </span><span class="p">&amp;</span>
<span class="nv">pid</span><span class="o">=</span><span class="nv">$!</span>
<span class="nb">wait</span><span class="w"> </span><span class="nv">$pid</span>
<span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>

<span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">128</span><span class="w"> </span>+<span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># received SIGURG, keep waiting</span>
<span class="w">    </span><span class="nb">wait</span><span class="w"> </span><span class="nv">$pid</span>
<span class="w">    </span><span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>
<span class="k">fi</span>

<span class="nb">exit</span><span class="w"> </span><span class="nv">$ret</span>
</pre></div>
</div>
<p>The job is submitted as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">sbatch<span class="w"> </span>frontier.slurm</span>
</pre></div></div><p>where <code class="docutils literal notranslate"><span class="pre">frontier.slurm</span></code> is the name of the submission script.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the job times out before writing out a checkpoint (leaving a
<code class="docutils literal notranslate"><span class="pre">dump_and_stop</span></code> file behind), you can give it more time between the
warning signal and the end of the allocation by adjusting the
<code class="docutils literal notranslate"><span class="pre">#SBATCH</span> <span class="pre">--signal=B:URG&#64;&lt;n&gt;</span></code> line at the top of the script.</p>
<p>Also, by default, AMReX will output a plotfile at the same time as a checkpoint file,
which means you’ll get one from the <code class="docutils literal notranslate"><span class="pre">dump_and_stop</span></code>, which may not be at the same
time intervals as your <code class="docutils literal notranslate"><span class="pre">amr.plot_per</span></code>.  To suppress this, set:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>amr.write_plotfile_with_checkpoint<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
</div>
<p>Also see the WarpX docs: <a class="reference external" href="https://warpx.readthedocs.io/en/latest/install/hpc/frontier.html">https://warpx.readthedocs.io/en/latest/install/hpc/frontier.html</a></p>
</section>
<section id="gpu-aware-mpi">
<h3>GPU-aware MPI<a class="headerlink" href="#gpu-aware-mpi" title="Link to this heading"></a></h3>
<p>Some codes run better with GPU-aware MPI.  To enable this add the following to your
submission script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">MPICH_GPU_SUPPORT_ENABLED</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FI_MR_CACHE_MONITOR</span><span class="o">=</span>memhooks
</pre></div>
</div>
<p>and set the runtime parameter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>amrex.use_gpu_aware_mpi<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</section>
<section id="job-status">
<h3>Job Status<a class="headerlink" href="#job-status" title="Link to this heading"></a></h3>
<p>You can check on the status of your jobs via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">squeue<span class="w"> </span>--me</span>
</pre></div></div><p>and get an estimated start time via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">squeue<span class="w"> </span>--me<span class="w"> </span>--start</span>
</pre></div></div></section>
<section id="job-chaining">
<h3>Job Chaining<a class="headerlink" href="#job-chaining" title="Link to this heading"></a></h3>
<p>The script <a class="reference external" href="https://github.com/AMReX-Astro/workflow/blob/main/job_scripts/slurm/chainslurm.sh">chainslurm.sh</a> can be used to start
a job chain, with each job depending on the previous.  For example, to start up
10 jobs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">chainslurm<span class="w"> </span>-1<span class="w"> </span><span class="m">10</span><span class="w"> </span>frontier.slurm</span>
</pre></div></div><p>If you want to add the chain to an existing queued job, change the <code class="docutils literal notranslate"><span class="pre">-1</span></code> to the job-id
of the existing job.</p>
</section>
<section id="debugging">
<h3>Debugging<a class="headerlink" href="#debugging" title="Link to this heading"></a></h3>
<p>Debugging is done with <code class="docutils literal notranslate"><span class="pre">rocgdb</span></code>.  Here’s a workflow that works:</p>
<p>Setup the environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">module<span class="w"> </span>load<span class="w"> </span>PrgEnv-gnu</span>
<span class="prompt1">module<span class="w"> </span>load<span class="w"> </span>cray-mpich/8.1.27</span>
<span class="prompt1">module<span class="w"> </span>load<span class="w"> </span>craype-accel-amd-gfx90a</span>
<span class="prompt1">module<span class="w"> </span>load<span class="w"> </span>amd-mixed/5.6.0</span>
</pre></div></div><p>Build the executable.  Usually it’s best to disable MPI if possible
and maybe turn on <code class="docutils literal notranslate"><span class="pre">TEST=TRUE</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">make<span class="w"> </span><span class="nv">USE_HIP</span><span class="o">=</span>TRUE<span class="w"> </span><span class="nv">TEST</span><span class="o">=</span>TRUE<span class="w"> </span><span class="nv">USE_MPI</span><span class="o">=</span>FALSE<span class="w"> </span>-j<span class="w"> </span><span class="m">4</span></span>
</pre></div></div><p>Startup an interactive session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">salloc<span class="w"> </span>-A<span class="w"> </span>ast106<span class="w"> </span>-J<span class="w"> </span>mz<span class="w"> </span>-t<span class="w"> </span><span class="m">0</span>:30:00<span class="w"> </span>-p<span class="w"> </span>batch<span class="w"> </span>-N<span class="w"> </span><span class="m">1</span></span>
</pre></div></div><p>This will automatically log you onto the compute now.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s a good idea to do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">module<span class="w"> </span>restore</span>
</pre></div></div><p>and then reload <em>the same</em> modules used for compiling in the interactive shell.</p>
</div>
<p>Now set the following environment variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nb">export</span><span class="w"> </span><span class="nv">HIP_ENABLE_DEFERRED_LOADING</span><span class="o">=</span><span class="m">0</span></span>
<span class="prompt1"><span class="nb">export</span><span class="w"> </span><span class="nv">AMD_SERIALIZE_KERNEL</span><span class="o">=</span><span class="m">3</span></span>
<span class="prompt1"><span class="nb">export</span><span class="w"> </span><span class="nv">AMD_SERIALIZE_COPY</span><span class="o">=</span><span class="m">3</span></span>
</pre></div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can also set</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nb">export</span><span class="w"> </span><span class="nv">AMD_LOG_LEVEL</span><span class="o">=</span><span class="m">3</span></span>
</pre></div></div><p>to get <em>a lot</em> of information about the GPU calls.</p>
</div>
<p>Run the debugger:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">rocgdb<span class="w"> </span>./Castro2d.hip.x86-trento.HIP.ex</span>
</pre></div></div><p>Set the following inside of the debugger:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt2:before {
  content: "(gdb) ";
}
</style><span class="prompt2">set pagination off</span>
<span class="prompt2">b abort</span>
</pre></div></div><p>The run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2">run inputs</span>
</pre></div></div><p>If it doesn’t crash with the trace, then try:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2">interrupt</span>
<span class="prompt2">bt</span>
</pre></div></div><p>It might say that the memory location is not precise, to enable precise
memory, in the debugger, do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2">set amdgpu precise-memory on</span>
<span class="prompt2">show amdgpu precise-memory</span>
</pre></div></div><p>and rerun.</p>
</section>
<section id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading"></a></h3>
<p>Workaround to prevent hangs for collectives:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">FI_MR_CACHE_MONITOR</span><span class="o">=</span>memhooks
</pre></div>
</div>
<p>Some AMReX reports are that it hangs if the initial Arena size is too
big, and we should do</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>amrex.the_arena_init_size<span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
<p>The arena size would then grow as needed with time.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="olcf-compilers.html" class="btn btn-neutral float-left" title="Compiling at OLCF" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="olcf-jupyter.html" class="btn btn-neutral float-right" title="Running Jupyter Remotely from OLCF" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2024, AMReX-Astro development tem.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>